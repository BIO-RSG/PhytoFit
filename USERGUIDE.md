# PhytoFit User Guide
2020-09-25  
Report issues to: Stephanie.Clay@dfo-mpo.gc.ca  
  
***

## ACCESSING THE APP


### Option 1: DM APPS
*(DFO VPN access required)*  
*Address: http://dmapps:3838/PhytoFit/*

<br>  

### Option 2: Github
*(Publicly available, updated more frequently)*  
*Address: https://github.com/BIO-RSG/PhytoFit*  

<br>  

#### PREREQUISITES:
1. Install the latest versions of R and RStudio.
2. Install the necessary libraries:
`install.packages(c("fst", "shiny", "shinyWidgets", "shinyjs", "shinybusy", "htmlwidgets", "leaflet", "leaflet.extras", "quantreg", "minpack.lm", "rgdal", "sp", "ggplot2", "grid", "gridExtra", "dplyr", "geometry", "raster", "proj4"))`
3. Install a fix for the leaflet.extras package:
``` r
install.packages("remotes")
remotes::install_github("bhaskarvk/leaflet.extras", ref = remotes::github_pull("184"))
```
4. Restart R after the packages and fix have been installed.
5. Download repository from github.  

<br>  

#### INSTRUCTIONS:
Open app.R within RStudio, and click "Run app".  

<br>  

#### WARNINGS FOR R USERS ONLY:
* Memory usage increases as data is loaded/processed in the app. If the app is slowing down the computer, restart R (Session --> Restart R).  

* *Warning in if (sigma_limit1 < 0) { : the condition has length > 1 and only the first element will be used.*  [This warning might appear when running a Gaussian fit if two separate days have the same maximum chl-a concentration (the first instance of the maximum concentration will be used).]  

* Density plot error: *could not find function "expansion"*  
	Solution: Update ggplot2 package  

***

## WARNINGS  


* Large custom polygons (>500 degrees square) are not allowed due to memory issues.

* Small custom polygons (i.e. < a few pixels) will give unpredictable results because the map displays a projected raster of the original binned data, so the location of points is not 100% accurate, but very close. This could become noticeable if the user tries to select a very small number of datapoints on the map since the selection might contain a different number of binned values than rasterized pixels, or pixels with noticeably different values than the binned values due to projection issues.  

* Do not leave the app running for an extended period of time (hours) or through several large time series processing runs (for example, using all existing boxes for all available years). It's a good idea to restart every now and then to clear memory.  


***

## FUTURE OPTIONS


* Manually adjust fit parameters
* SeaWiFS and OLCI 4km
* Infer starting guesses for *nlsLM()* from the actual values (example: B<sub>0</sub> = median chlorophyll-a), or allow user to select them
* Exclude specific days from the fit
* Disjoint polygons
* Script contains code to create a popup when user clicks a single point on the map, displaying the latitude/longitude/chlorophyll value at that point. The code displays two chla values: "rasterized.chlorophyll.a", which is the value projected on the map, and "chlorophyll.a", which is the actual binned value nearest that point. [This popup feature is currently disabled because the popups interfere with drawing/editing polygons.]

***

## REFERENCES AND DATA SOURCES


Paper detailing the chlorophyll-a algorithms (*OCx*, *POLY4*, and *GSM_GS*):  
[Clay, S.; Peña, A.; DeTracey, B.; Devred, E. Evaluation of Satellite-Based Algorithms to Retrieve Chlorophyll-a Concentration in the Canadian Atlantic and Pacific Oceans. Remote Sens. 2019, 11, 2609.](https://www.mdpi.com/2072-4292/11/22/2609)  

Tech Report with descriptions of the bloom fitting models (*Shifted Gaussian*, *Rate of Change*, and *Threshold* methods):  
IN PROGRESS  

**Data used**:  
Daily level-3 binned files are downloaded from [NASA OBPG](https://oceancolor.gsfc.nasa.gov), and weekly composites are generated by taking the average of each pixel over an 8-day period (46 weeks/year), following the same system as NASA OBPG. The binned data is used for statistics and bloom fitting, and rasterized and projected onto the map using [EPSG:3857](https://spatialreference.org/ref/sr-org/7483/) (the Web Mercator projection) for faster image loading.  
[NASA OCx chlorophyll-a algorithm](https://oceancolor.gsfc.nasa.gov/atbd/chlor_a)  
[Level-3 binned files](https://oceancolor.gsfc.nasa.gov/products)  
[Binning scheme](https://oceancolor.gsfc.nasa.gov/docs/format/l3bins)  
[Level-3 binned default flags](https://oceancolor.gsfc.nasa.gov/atbd/ocl2flags)  
*NOTE: Flags used = L3 default mask, and FILTER*  


***

## INSTRUCTIONS


<br>  

### LEFT SIDEBAR

Select:  

1.  Satellite/resolution  
    + MODIS-Aqua 4km-resolution  
    + VIIRS-SNPP 4km-resolution  
    + SeaWiFS 4km-resolution  
2.  Region  
    + Atlantic (42 to 71 degrees west, 39 to 63 degrees north)  
    + Pacific (122 to 140 degrees west, 46 to 60 degrees north)  
3. Algorithm  
    + OCx (global, band ratio)  
    + POLY4 (regional, band ratio)  
    + GSM_GS (regional, semi-analytical)  
4. Year  
    + 2003-2020 (MODIS)  
    + 2012-2020 (VIIRS)  
    + 1998-2010 (SeaWiFS)  
5. Temporal binning  
    + Daily  
    + Weekly (mean value of 8-day intervals)  
6. Logged or unlogged chlorophyll-a  

Click "Load data".  
*NOTE: Changes to any of the 6 options above will not be used until the "load" button is clicked.*

<br>  

#### COLOUR SCALE
Adjust range of data used in the map colour scale.  

<br>  

#### DAY OF YEAR
Enter a day of year from 1-365 and click "Go", or use the slider and play/pause button to advance through the days automatically.  

<br>  

#### POLYGON

Click the grey/green "Polygon" button to expand the menu, then use the drop-down menu to choose an existing polygon which will be highlighted on the map, or choose "Custom polygon" to create your own.  

If you choose "Custom polygon":  

1. *(Optional)* Name your polygon and click "Apply"  
2. Choose how to define polygon vertices:  
<br>
    + **Option 1:** Draw it on the map  
      
      Scroll up to the draw toolbar at the top left corner of the map.  
      Controls on the toolbar: zoom in/out, draw irregular polygon or a box, edit polygon, and delete polygon.  
      To draw an irregular polygon, click the first draw icon (the pentagon) and click the points on the map where you want the vertices to be. To finish the polygon, click the first point or click the "finish" button.  
      To draw a square, use the second draw icon.  
      As of 26 Sep 2020, only one polygon can be drawn on the map at a given time. If you draw a new polygon, the old one will be deleted automatically. 
    + **Option 2:** Type the coordinates of the vertices and click "Create polygon"  
    
      Latitide/longitude formatting:  
        + decimal degrees  
        + separated by commas  
        + use latitude/longitude < 0 for south/west  

<br>  

#### STATISTICS

Click the grey/green "Statistics" button to expand the menu.  

1.  Minimum daily percent coverage  
    If the polygon does not have the required percent coverage for the selected day/week, the density plot will not be created.       Days/weeks below this percentage will be excluded from the time series and not used in the bloom fitting.  

2.  Outlier detection method  
      + mean ± 2 standard deviations  
      + mean ± 3 standard deviations  
      + median ± 1.5 * interquartile range  
  
3.  Daily statistic (mean or median)  
    Statistic computed on the chlorophyll within the selected polygon for each day/week.  

4.  Range of pixel values  
    Pixels outside this range will not be used in the computation of the statistics or bloom fit.  

<br>  

#### BLOOM FITTING

Click the grey/green "Bloom fit" button to expand the menu.  

Each point in the time series and bloom fit is the daily (or weekly) spatial average (or median) of data after removal of outliers and points outside the desired range, using the binned chlorophyll-a values. Only points with sufficient percent coverage inside the polygon on that day/week are used, within the range of days selected by the user.  

Amplitude<sub>real</sub>: Height of the real data values at t<sub>max</sub> (peak value minus background chlorophyll-a)  
Magnitude<sub>real</sub>: Area under the real data points from start to end of the bloom, excluding background chlorophyll-a  

Gaussian fit only:  
Amplitude<sub>fit</sub>: Height of the curve at t<sub>max</sub> (peak value minus background chlorophyll-a)  
Magnitude<sub>fit</sub>: Area under the curve from start to end of the bloom, excluding background chlorophyll-a  

Amplitude units: mg m<sup>-3</sup>  
Magnitude units: (mg m<sup>-3</sup>) * days  

<br><br>


1.  Choose the fit method  
    + Shifted Gaussian (recommended)  
    + Rate of Change  
    + Threshold  
    See [TECH REPORT 2020 LINK] for details, or scroll down for a brief description.  
<br>

2.  Choose the shape of the curve  
    + Symmetric  
    + Asymmetric  
<br>

3.  Point smoothing  
    + No smoothing  
    + LOESS (locally estimated scatterplot smoothing)  
      + LOESS span (a parameter to control the degree of smoothing)  
<br>

4.  t<sub>range</sub> slider  *(Default: 31-274)*  
    Set the range of days to use in the fit.  
    *NOTE: The t<sub>start</sub> and t<sub>max</sub> sliders will automatically be adjusted to be within t<sub>range</sub>*.  
<br>

5.  t<sub>max</sub> slider  *(Default: 91-181)*  
    Set the range of days to search for the maximum concentration of the bloom.  
    *NOTE: This is restricted by t<sub>range</sub>, and t<sub>start</sub> will be automatically adjusted based on this value*.  
<br>

6.  t<sub>start</sub> slider  *(Default: 60-151)*  
    Set the range of days to search for the initiation of the bloom.  
    *NOTES:*  
    + *This is restricted by t<sub>range</sub> and t<sub>max</sub>*  
    + *If the t<sub>max</sub> switch (not the slider) is set to ON, this option is unavailable (see t<sub>max</sub> switch below for explanation)*  
<br>

7.  Extra options  

    + For Shifted Gaussian:  
    
        + t<sub>max</sub> switch (NOT the slider)  
        Allow t<sub>max</sub> to vary as a parameter within *nlsLM()*, rather than being a fixed value based on the actual maximum concentration.
        
          > *NOTE: t<sub>start</sub> can't be restricted if this is set to ON*.  
          > The reason for this: t<sub>start</sub> is restricted by adjusting σ, the parameter controlling the width of the curve, relative to a constant t<sub>max</sub>. If the t<sub>max</sub> button is set to ON, then both σ and t<sub>max</sub> are allowed to vary as parameters within *nlsLM()*, so they can't be used to restrict t<sub>start</sub> to a constant range of possible days.  
          > If the t<sub>max</sub> button is OFF and t<sub>start</sub> is limited, the limitations on t<sub>start</sub> are implemented by adjusting the limitations on σ, like so:  
          > σ<sub>upper</sub> = (t<sub>max</sub> - t<sub>start_lower</sub>) / 1.79  
          > σ<sub>lower</sub> = (t<sub>max</sub> - t<sub>start_upper</sub>) / 1.79  
        
        + β * t  
        Allow a linear rate of change on either side of the bloom curve (this can tilt the horizontal line of background chlorophyll-a).  
        
        + weights  
        Weight each point in the fit by the percent coverage inside the polygon on that day/week.  
        
        + Flags  
          Fits are flagged (unaffected but marked) if the following occurs:  
          Flag 1: (Fitted curve at t<sub>max</sub>) / (Real value at t<sub>max</sub>) is outside the range specified by the user (default: 0.75-1.25)  
          Flag 2: (Magnitude under curve) / (Magnitude under real values) is outside the range specified by the user (default: 0.85-1.15)  
          Flag 3: Sigma (parameter controlling the width of the curve) is <= time resolution (i.e 1 for daily data, or 8 for weekly data)  
        
        
    + For Threshold:  
    
        + threshold coefficient  
        
          > t<sub>start</sub> is defined as the point where chlorophyll-a drops below the threshold for > 14 days, measuring the days/weeks backward from the day of maximum concentration  
          > threshold = (threshold coefficient) * (median chlorophyll-a)  
          > median chlorophyll-a = median of the chlorophyll-a within the selected day range and >= the selected percent coverage (i.e. all the data points used in a bloom fit) 


<br>  

##### SHIFTED GAUSSIAN  

<a target="_blank" href="userguide_bf_eq01.png">
<img src="userguide_bf_eq01.png" alt="screencap" width="280"/>
</a>

| Parameter | Units | Description |
| --------- | ----- | ----------- |
| B | mg m<sup>-3</sup> | vector of mean (or median) measured chla concentration for each day (or week) |
| t | day of year | vector of days, same length as B |
| B<sub>0</sub> | mg m<sup>-3</sup> | background chlorophyll-a concentration |  
| β (beta) |	mg m<sup>-3</sup> day<sup>-1</sup> | linear rate of change of B<sub>0</sub> |  
| h | unitless | controls the height of the curve |  
| σ (sigma)	| unitless | controls the width of the curve |  
| t<sub>max</sub>	| day of year | day of maximum B |  

<br>

Unknown parameters calculated by nonlinear least squares:  
B<sub>0</sub>, h, σ (optional: β, t<sub>max</sub>)  

R function used for the nonlinear least squares fit to calculate the parameters: *nlsLM* (from the *minpack.lm* package)  

Lower/upper limits and starting guesses for *nlsLM*:  
  
|                |   | B<sub>0</sub> | h   | σ   | β      | t<sub>max</sub>           |
|----------------|---|---------------|-----|-----|--------|---------------------------|
| Lower limit    |   | 0             | 0   | 0   | -0.02  | User-selected             |
| Upper limit    |   | 5             | 350 | 100 | 0.01   | User-selected             |
| Starting guess | 1 | 0.5           | 50  | 10  | -0.002 | day of chla<sub>max</sub> |
|                | 2 | 0.5           | 50  | 2   | -0.002 | day of chla<sub>max</sub> |
|                | 3 | 0.5           | 10  | 2   | -0.001 | day of chla<sub>max</sub> |
|                | 4 | 0.5           | 10  | 1   | -0.001 | day of chla<sub>max</sub> |

*NOTES:*  

* _If curve is asymmetric, the same limits and guesses are used for each side_  
* _4 different sets of starting guesses are attempted before a dataset is declared unable to fit_  
* _If you're fitting weekly data, the week numbers are converted to the day of year at the start of each week, so the units are still day of year_  

<br>

B<sub>0</sub> limits if using logged chlorophyll-a: log(10<sup>-10</sup>) to log(5); starting guess: log(0.5)

This will create a blue fitted curve through the points.  

<br>  

##### RATE OF CHANGE  

This algorithm does not calculate a daily fitted equation, only the maximum, start, and end days of the bloom.  
The maximum is selected as the day of actual maximum concentration, within the selected range.  
The initiation is the day of the maximum rate of change in concentration, within the selected bounds.  
If any indices cannot be computed, they will be blank and not appear on the time series plot.  

B<sub>0</sub> is computed using the R function *rq()* from the *quantreg* package to perform a quantile regression (25th percentile) on the full dataset (days/weeks with sufficient percent coverage), and used to calculate the amplitude of the curve and the magnitude under the curve.  

<br>  

##### THRESHOLD  

This algorithm does not calculate a daily fitted equation, only the maximum, start, and end days of the bloom.  
The maximum is selected as the day of actual maximum concentration, within the selected range.  
The initiation is the day that chlorophyll-a drops below a threshold for > 14 consecutive days, working backward from the day of maximum concentration.  

If you are using non-logged chl-a:  

Threshold = (Threshold coefficient) * (median chlorophyll-a used in the fit)  

If you are using logged chl-a:  

Threshold = log10((Threshold coefficient) * 10^(median log10(chlorophyll-a) used in the fit))  

Threshold coefficient = user-selected  

B<sub>0</sub> is computed using the same method as with the Rate of Change model.  

<br>  

#### EXPORT OPTIONS  

1. Settings (.txt)  

2. Map (.html)  

3. Density plot (.png)  

4. Time series plot (.png)  

5. Annual table of daily (or weekly) statistics (.csv)  

6. Table of fitted bloom parameters (.csv)  

7. Download results from a series of years and polygons (.zip)  
  Instructions:  
  * Select years using year slider  
  * Select polygons with the radio buttons  
    * Process all polygons, or  
    * Select polygons to process  
    Make sure you have at least one polygon selected, also if you have selected "Custom polygon", make sure the polygon is defined.  
    Note: if you de-select all polygons, it will still use the polygon that you de-selected last.  
  
  * Click "Run time series"  
    This will create:  
    * PNG files for the bloom fit for each of the selected years  
    * CSV files for each year containing the statistics for each day  
    * CSV file containing the fit parameters for those years  
    * TXT file containing the settings for the current run  
    Files will be zipped to a folder with the following name convention:  
    **satellite_ region_ algorithm_ years_ interval_ (un)loggedChla_ fitmethod_ timecreated.zip**  
  
  * "Download results (.zip)"  
    This will download the zipped file to your browser's downloads folder.  



<br>  

### MAIN VIEW PANEL  

<br>  

#### MAP  

TOP LEFT:  
	Zoom controls  
	Draw sidebar (if "custom polygon" is selected and data exists and is loaded for that day)  
		Shapes:  
			a. Irregular polygon (finish the polygon by clicking on the starting point)  
			b. Rectangle  
		Edit (click "save" when done, or cancel)  
		Delete (click "save" when done, or cancel)  

TOP RIGHT:  
	Gridlines checkbox - uncheck to remove gridlines  
	Stats boxes checkbox - uncheck to remove existing (pre-defined) statistics boxes  
	Color bar, after data is loaded  

BOTTOM:  
  Download button (map downloads in html format, which allows zooming/panning)   


<br>  

#### DENSITY PLOT  


<br>  

#### TIME SERIES PLOT  

Click on a data point and scroll up to see the data for that day (or week).  



***
## AZMP FITTING PARAMETERS  

AZMP boxes are typically fitted using a Fortran script, examining and adjusting every fit manually.  
Results found here: ftp://ftp.dfo-mpo.gc.ca/bometrics/spring-bloom  


Data used in the fit:  
  * Sensor: VIIRS-SNPP  
  * Resolution: ~1 km  
  * L2 flags used: All flags except TURBIDW (turbid water)  
  * Mapped to (39-82N, 42-95W) using cylindrical projection  
  * Chlorophyll algorithm: Standard ocean colour algorithm (OCx) from NASA, NOT logged  
  * Temporal binning: Weekly (daily can be too spiky, semi-monthly might miss the bloom)  

Statistics used in the fit:  
  * Minimum weekly percent coverage inside a box: 1%  
  * Outliers NOT removed  
  * Weekly statistic used in a box: Mean  
  * Range of pixel values used: <= 64 mg/m^3

Bloom fitting:  
  * Model: Symmetric Shifted Gaussian  
  * Range of days used in fit: Feb-July, and Feb-Aug for more northern boxes (>= 56N)
  * No limit on day of max concentration or start of bloom, and points NOT weighted by percent coverage inside the box.  

Fits flagged if the following occurs:  
  * Box has < 10% coverage (if so, the individual images that produced the stats are examined, and some might be removed and the bloom refitted, or they might be left in with a note of caution because removing them could remove the bloom from the image)  
  * Ratio of peak chla concentrations (i.e. (chla<sub>max_curve</sub>) / (chla<sub>max_real</sub>) ) is not between 0.75 and 1.25  
  * Ratio of magnitudes (area under the curve), Magnitude<sub>real</sub> / Magnitude<sub>curve</sub> is >= 0.15  
  * Sigma (parameter controlling the width of the curve) is <= time resolution (i.e 1 day, or a week)  



### Differences between AZMP Fortran/manual fitting and PhytoFit  

Some differences are unavoidable due to the following:  

  - PhytoFit uses the 8-day-per-week system (same as NASA) for weekly files, but AZMP fits use a 4-week-per-month system, so the weeks are not all the same length.  
  - PhytoFit uses binned data (similar to a sinusoidal projection), but AZMP fits use files that have a cylindrical projection.  
  - PhytoFit uses the default L3b NASA flags + FILTER ([here](https://oceancolor.gsfc.nasa.gov/atbd/ocl2flags)), but AZMP fits use files with all L2 NASA flags except TURBIDW.  
  - PhytoFit is automated, but each AZMP fit is inspected manually and adjusted as necessary.  

*NOTE: The "fit flags" have slightly different definitions for PhytoFit and AZMP fits, but they do not affect the statistics/fit, only warn the user that the fit might have issues.*  


##### **PhytoFit settings to get most similar results to AZMP fits:**  

*Note: any settings that are not listed here have no constraints*  

    Satellite: VIIRS-SNPP 4km  
    Algorithm: OCx (global, band ratio)  
    Interval: Weekly  
    Chlorophyll-a logged: FALSE  
    Minimum weekly percent coverage: 1  
    Outlier detection method: None  
    Weekly statistic: Average  
    Minimum value used in the statistics and fit: 0 (leave the box blank in the app)  
    Maximum value used in statistics and fit: 64  
    Fit method: Shifted Gaussian  
    Bloom fit shape: Symmetric  
    Smoothing method: No smoothing  
    Allowed range of days for bloom fitting:  
      - For boxes < 56 degrees North: 31-212 (Feb-Jul)  
      - For boxes >= 56 degrees North: 31-244 (Feb-Aug)  
    Use t[max] parameter: FALSE  
    Use beta parameter: FALSE  
    Weight fit points by weekly percent coverage: FALSE  

